<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Simulator (20Q)</title>
  <meta name="theme-color" content="#0b0b0c" />
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0b0c; color: #f2f2f2; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 18px; }
    .card { background: #151518; border: 1px solid #24242a; border-radius: 18px; padding: 16px; }
    h1 { font-size: 18px; margin: 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content: space-between; }
    .controls { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    select, button {
      background: #1c1c22; color: #f2f2f2; border: 1px solid #2a2a33;
      border-radius: 14px; padding: 11px 12px; font-size: 14px;
    }
    button { cursor:pointer; }
    button:disabled { opacity: 0.55; cursor:not-allowed; }
    .muted { color:#b5b5c0; font-size: 13px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid #2a2a33; background:#111116; font-size: 12px; color:#cfcfe1;}
    .spacer { height: 14px; }

    .qbox { background:#101014; border:1px solid #24242a; border-radius: 18px; padding: 16px; }
    .qtop { display:flex; justify-content: space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .q { font-size: 18px; line-height: 1.35; margin: 12px 0 12px; }

    .answers { display:grid; gap: 10px; }
    .ans {
      text-align:left; width:100%;
      background:#1c1c22; border:1px solid #2a2a33; border-radius: 14px;
      padding: 12px; font-size: 15px;
    }
    .ans.correct { border-color: #2f6f3b; background: #142017; }
    .ans.wrong { border-color: #7a2c2c; background: #231414; }

    .center { text-align:center; }
    .big { font-size: 22px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h1>Test Simulator</h1>
        <span class="pill">20 questions</span>
      </div>

      <div class="spacer"></div>

      <div class="controls">
        <label class="muted">Subject</label>
        <select id="subjectSelect"></select>
        <button id="btnStart">Start 20Q Run</button>
      </div>

      <div class="spacer"></div>

      <div class="qbox" id="mainBox">
        <div class="qtop">
          <span class="pill" id="progressPill">Not started</span>
          <span class="muted" id="scoreMini"></span>
        </div>

        <div class="q" id="qText" style="margin-top: 16px;">
          Pick a subject and press <b>Start 20Q Run</b>.
        </div>

        <div class="answers" id="answers"></div>

        <div class="spacer"></div>
        <div class="muted" id="feedback"></div>

        <div class="spacer"></div>
        <div class="controls">
          <button id="btnNext" disabled>Next</button>
          <button id="btnRestart" style="display:none;">Restart</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="muted">
        Tip: On Android Chrome you can install it:
        <b>⋮ → Add to Home screen</b>.
      </div>
    </div>
  </div>

<script>
/** ---------------- Load questions.json from your site ---------------- **/
async function loadQuestionsFromFile() {
  try {
    const res = await fetch("./questions.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Could not fetch questions.json");
    const data = await res.json();
    const questions = Array.isArray(data) ? data : data.questions;
    if (!Array.isArray(questions)) throw new Error("Invalid questions.json format");
    validateBank(questions);
    return questions;
  } catch (e) {
    // Fallback demo bank if questions.json fails
    console.warn(e);
    return DEMO_BANK;
  }
}

function validateBank(questions) {
  for (const q of questions) {
    if (!q.id || !q.subject || !q.question || !Array.isArray(q.choices) || typeof q.answerIndex !== "number") {
      throw new Error("A question is missing required fields.");
    }
    if (q.answerIndex < 0 || q.answerIndex >= q.choices.length) {
      throw new Error(`Question ${q.id} has invalid answerIndex.`);
    }
  }
}

/** ---------------- Demo questions (only used if questions.json can’t load) ---------------- **/
const DEMO_BANK = [
  { id:"bio_1", subject:"Biology", question:"Which organelle produces ATP?", choices:["Nucleus","Mitochondria","Ribosome","Golgi apparatus"], answerIndex:1, explanation:"Mitochondria produce ATP." },
  { id:"hist_1", subject:"History", question:"Which factor contributed to instability in Weimar?", choices:["Two-party system","Many parties via proportional representation","No elections","Absolute monarchy"], answerIndex:1, explanation:"Fragmentation made stable majorities difficult." },
  { id:"powi_1", subject:"PoWi", question:"A common argument for state intervention is…", choices:["End competition","Correct market failures","Remove all taxes","End trade"], answerIndex:1, explanation:"Intervention often targets market failures." },
  { id:"spa_1", subject:"Spanish", question:"Correct subjunctive after 'Es posible que':", choices:["…viene","…venga","…venir","…viniendo"], answerIndex:1, explanation:"'Es posible que' triggers subjunctive." },
  { id:"eng_1", subject:"English", question:"Which word is most formal?", choices:["gonna","kinda","therefore","wanna"], answerIndex:2, explanation:"'Therefore' is formal." },
  { id:"phy_1", subject:"Physics", question:"Ohm’s law is…", choices:["P=U·I","U=R·I","E=m·c²","F=m·a"], answerIndex:1, explanation:"Voltage equals resistance times current." }
];

/** ---------------- Helpers ---------------- **/
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function uniqueSubjects(bank){
  return [...new Set(bank.map(q => q.subject))].sort((a,b)=>a.localeCompare(b));
}

/** ---------------- App state ---------------- **/
let BANK = [];
let RUN = [];            // exactly 20 questions (or fewer if not enough exist)
let index = 0;
let score = 0;
let locked = false;
let current = null;
let currentCorrectDisplayIndex = -1;

/** ---------------- UI ---------------- **/
const subjectSelect = document.getElementById("subjectSelect");
const btnStart = document.getElementById("btnStart");
const btnNext = document.getElementById("btnNext");
const btnRestart = document.getElementById("btnRestart");
const qText = document.getElementById("qText");
const answersDiv = document.getElementById("answers");
const feedback = document.getElementById("feedback");
const progressPill = document.getElementById("progressPill");
const scoreMini = document.getElementById("scoreMini");

function setIdleUI(){
  progressPill.textContent = "Not started";
  scoreMini.textContent = "";
  qText.innerHTML = `Pick a subject and press <b>Start 20Q Run</b>.`;
  answersDiv.innerHTML = "";
  feedback.textContent = "";
  btnNext.disabled = true;
  btnRestart.style.display = "none";
}

function buildRun(subject){
  const pool = BANK.filter(q => q.subject === subject);
  const shuffled = shuffle(pool);

  // Exactly 20 questions if possible. If fewer exist, use all available.
  RUN = shuffled.slice(0, Math.min(20, shuffled.length));
  index = 0;
  score = 0;

  if (RUN.length < 20) {
    feedback.textContent = `⚠️ This subject currently has only ${RUN.length} questions. Add more to reach exactly 20.`;
  } else {
    feedback.textContent = "";
  }
}

function renderQuestion(){
  locked = false;
  btnNext.disabled = true;
  answersDiv.innerHTML = "";
  feedback.textContent = "";

  current = RUN[index];

  progressPill.textContent = `Question ${index + 1} / ${RUN.length}`;
  scoreMini.textContent = `Score: ${score}`;

  qText.textContent = current.question;

  // shuffle answers for display
  const indices = shuffle(current.choices.map((_,i)=>i));
  const correctOriginal = current.answerIndex;
  currentCorrectDisplayIndex = indices.indexOf(correctOriginal);

  indices.forEach((origIdx, displayIdx) => {
    const b = document.createElement("button");
    b.className = "ans";
    b.textContent = current.choices[origIdx];
    b.onclick = () => choose(displayIdx, b);
    answersDiv.appendChild(b);
  });
}

function choose(chosenDisplayIdx, buttonEl){
  if(locked) return;
  locked = true;

  const buttons = [...answersDiv.querySelectorAll("button")];
  buttons.forEach(b => b.disabled = true);

  const correct = chosenDisplayIdx === currentCorrectDisplayIndex;

  if(correct){
    score += 1;
    buttonEl.classList.add("correct");
    buttons[currentCorrectDisplayIndex]?.classList.add("correct");
    feedback.textContent = "✅ Correct.";
  } else {
    buttonEl.classList.add("wrong");
    buttons[currentCorrectDisplayIndex]?.classList.add("correct");
    feedback.textContent = "❌ Wrong.";
  }

  if (current.explanation) {
    feedback.textContent += " " + current.explanation;
  }

  scoreMini.textContent = `Score: ${score}`;
  btnNext.disabled = false;
}

function finishRun(){
  answersDiv.innerHTML = "";
  const percent = Math.round((score / RUN.length) * 100);

  progressPill.textContent = "Finished";
  qText.innerHTML = `
    <div class="center">
      <div class="big">Done ✅</div>
      <div class="spacer"></div>
      <div>You scored <b>${score} / ${RUN.length}</b> (${percent}%).</div>
      <div class="spacer"></div>
      <div class="muted">Restart to do a new randomized run.</div>
    </div>
  `;
  feedback.textContent = "";
  btnNext.disabled = true;
  btnRestart.style.display = "inline-block";
}

btnStart.addEventListener("click", () => {
  const subject = subjectSelect.value;
  buildRun(subject);

  if(RUN.length === 0){
    qText.textContent = "No questions found for this subject. Add some to questions.json.";
    return;
  }

  renderQuestion();
});

btnNext.addEventListener("click", () => {
  if(!RUN.length) return;
  if(index < RUN.length - 1){
    index += 1;
    renderQuestion();
  } else {
    finishRun();
  }
});

btnRestart.addEventListener("click", () => {
  const subject = subjectSelect.value;
  buildRun(subject);
  renderQuestion();
});

/** ---------------- PWA service worker ---------------- **/
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/** ---------------- Init ---------------- **/
(async function init(){
  BANK = await loadQuestionsFromFile();

  const subs = uniqueSubjects(BANK);
  subjectSelect.innerHTML = "";
  for(const s of subs){
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    subjectSelect.appendChild(opt);
  }

  setIdleUI();
})();
</script>
</body>
</html>
